import{links,resources,initializeDataPreview}from"./dataManager.js";import{renderQuickLinks,renderLinks,renderResources}from"./uiManager.js";import{currentMode}from"./modeManager.js";import{updateEngineDropdown}from"./engineManager.js";let pendingDeleteIndex=-1,currentEditIndex=-1,pendingDeleteResourceIndex=-1;function addItem(e){let t,n,o,i,r,c;"link"===e?(t="linkName",n="linkUrl",o="linkImageUrl",i=links,r="navLinks",c=()=>{renderLinks(),renderQuickLinks()}):"resource"===e&&(t="resourceName",n="resourceUrl",o="resourceImageUrl",i=resources,r="navResources",c=()=>{renderResources(),"resource"===currentMode&&updateEngineDropdown()});const a=document.getElementById(t).value.trim(),l=document.getElementById(n).value.trim(),s=document.getElementById(o).value.trim();if(!l)return void alert(`请填写${"link"===e?"网站":"资源"}地址`);const d=l.startsWith("http")?l:"https://"+l,u=s||getCachedFaviconUrl(d);i.push({name:a,url:d,faviconUrl:u}),localStorage.setItem(r,JSON.stringify(i)),document.getElementById(t).value="",document.getElementById(n).value="",document.getElementById(o).value="",c(),initializeDataPreview()}function addLink(){addItem("link")}function addResource(){addItem("resource")}function deleteLink(e){pendingDeleteIndex=e,showConfirmDialog()}function deleteResource(e){pendingDeleteResourceIndex=e,showConfirmResourceDialog()}function showConfirmResourceDialog(){document.getElementById("confirmResourceDialog").classList.add("show")}function closeConfirmResourceDialog(){document.getElementById("confirmResourceDialog").classList.remove("show"),pendingDeleteResourceIndex=-1}function confirmDeleteItem(e){let t,n,o,i,r;if("link"===e?(t=pendingDeleteIndex,n=links,o="navLinks",i=()=>{renderLinks(),renderQuickLinks()},r=closeConfirmDialog):"resource"===e&&(t=pendingDeleteResourceIndex,n=resources,o="navResources",i=()=>{renderResources(),"resource"===currentMode&&updateEngineDropdown()},r=closeConfirmResourceDialog),t>=0&&t<n.length){try{const e=`favicon_cache_${new URL(n[t].url).hostname}`;localStorage.removeItem(e)}catch(e){}n.splice(t,1),localStorage.setItem(o,JSON.stringify(n)),i(),initializeDataPreview()}r()}function confirmDeleteResource(){confirmDeleteItem("resource")}function showConfirmDialog(){document.getElementById("confirmDialog").classList.add("show")}function closeConfirmDialog(){document.getElementById("confirmDialog").classList.remove("show"),pendingDeleteIndex=-1}function confirmDeleteLink(){confirmDeleteItem("link")}function showEditDialogByType(e,t){let n,o,i,r,c;currentEditIndex=e,"link"===t?(n=links[e],o="editLinkName",i="editLinkUrl",r="editLinkImageUrl",c="editDialog"):"resource"===t&&(n=resources[e],o="editResourceName",i="editResourceUrl",r="editResourceImageUrl",c="editResourceDialog"),document.getElementById(o).value=n.name,document.getElementById(i).value=n.url;const a=n.faviconUrl&&!n.faviconUrl.includes("google.com/s2/favicons")&&!n.faviconUrl.startsWith("data:image/svg+xml");document.getElementById(r).value=a?n.faviconUrl:"";document.getElementById(c).classList.add("show")}function showEditDialog(e){showEditDialogByType(e,"link")}function showEditResourceDialog(e){showEditDialogByType(e,"resource")}function closeEditDialog(){document.getElementById("editDialog").classList.remove("show"),currentEditIndex=-1}function closeEditResourceDialog(){document.getElementById("editResourceDialog").classList.remove("show"),currentEditIndex=-1}function formatUrl(e){return e.startsWith("http")?e:"https://"+e}function extractDomain(e){try{return new URL(e).hostname}catch{return null}}function clearDomainCache(e){const t=extractDomain(e);if(t){const e=`favicon_cache_${t}`;localStorage.removeItem(e)}}function validateFormData(e,t,n){return!!t||(alert(n),!1)}function saveEditedItem(e){let t,n,o,i,r,c,a;if("link"===e?(t=links,n="navLinks",o=()=>{renderLinks(),renderQuickLinks(),initializeDataPreview()},i=closeEditDialog,r="editLinkName",c="editLinkUrl",a="editLinkImageUrl"):"resource"===e&&(t=resources,n="navResources",o=()=>{renderResources(),initializeDataPreview(),"resource"===currentMode&&updateEngineDropdown()},i=closeEditResourceDialog,r="editResourceName",c="editResourceUrl",a="editResourceImageUrl"),currentEditIndex>=0&&currentEditIndex<t.length){const i=document.getElementById(r).value.trim(),l=document.getElementById(c).value.trim(),s=document.getElementById(a).value.trim();if(!validateFormData(i,l,`请填写${"link"===e?"网站":"资源"}地址`))return;const d=formatUrl(l);clearDomainCache(t[currentEditIndex].url);const u=s.trim()?s:getFaviconUrl(d);t[currentEditIndex]={name:i,url:d,faviconUrl:u},localStorage.setItem(n,JSON.stringify(t)),o()}i()}function saveEditedLink(){saveEditedItem("link")}function saveEditedResource(){saveEditedItem("resource")}function getDefaultFavicon(){return'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"%3E%3Cpath d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/%3E%3C/svg%3E'}function getFaviconUrl(e){try{const t=extractDomain(e);return t?`https://favicone.com/${t}?s=256`:getDefaultFavicon()}catch{return getDefaultFavicon()}}function getCachedFaviconUrl(e){try{const t=extractDomain(e);if(!t)return getDefaultFavicon();const n=`favicon_cache_${t}`,o=localStorage.getItem(n);if(o){const e=JSON.parse(o);if(Date.now()-e.timestamp<18e5)return e.faviconUrl}const i=`https://favicone.com/${t}?s=256`,r={faviconUrl:i,timestamp:Date.now()};return localStorage.setItem(n,JSON.stringify(r)),i}catch{return getDefaultFavicon()}}export{addLink,addResource,deleteLink,deleteResource,showConfirmResourceDialog,closeConfirmResourceDialog,confirmDeleteResource,showConfirmDialog,closeConfirmDialog,confirmDeleteLink,showEditDialog,showEditResourceDialog,closeEditDialog,closeEditResourceDialog,saveEditedLink,saveEditedResource,getFaviconUrl,getCachedFaviconUrl,formatUrl,extractDomain,clearDomainCache,validateFormData,getDefaultFavicon};
