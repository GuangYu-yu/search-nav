let suggestionCache=new Map,currentSuggestions=[],activeSuggestionIndex=-1;const engineLastRequestTime={duckduckgo:0,so360:0},SUGGESTION_APIS={duckduckgo:{url:"https://duckduckgo.com/ac/",params:{q:""}},so360:{url:"https://sug.so.360.cn/suggest",params:{word:"",encodein:"utf-8",encodeout:"utf-8",callback:"callback"}}};function performRequest(e,t,n){return"duckduckgo"===e?fetch(`${t.url}?${new URLSearchParams({...t.params,q:n})}`).then(e=>e.json()).then(t=>t.map(e=>e.phrase).map(t=>({text:t,source:e}))).catch(e=>(console.error("DuckDuckGo请求错误:",e),[])):new Promise((s,o)=>{const i="jsonp_callback_"+Date.now()+"_"+Math.round(1e5*Math.random()),c=document.createElement("script");window[i]=function(t){document.head.removeChild(c),delete window[i];try{let n=[];"so360"===e&&(n=t.result?t.result.map(e=>e.word||e):[]);const o=n.map(t=>{let n="";return n="string"==typeof t?t:"object"==typeof t&&null!==t?t.text||t.label||JSON.stringify(t):String(t),{text:n,source:e}});s(o)}catch(e){o(e)}};const r=new URLSearchParams({...t.params,[Object.keys(t.params).find(e=>"q"===e||"query"===e||"command"===e||"word"===e)]:n,[Object.keys(t.params).find(e=>"callback"===e||"JsonpCallback"===e)]:i}),a=`${t.url}?${r}`;c.src=a,c.onerror=function(){document.head.removeChild(c),delete window[i],o(new Error("Script load error for "+a))},document.head.appendChild(c),setTimeout(()=>{window[i]&&(document.head.removeChild(c),delete window[i],o(new Error("Request timeout for "+e)))},5e3)})}async function fetchSuggestions(e){if(suggestionCache.has(e))return suggestionCache.get(e);if(!e.trim())return[];document.querySelector(".engine-icon").className.split(" ").find(e=>e.endsWith("-icon")).replace("-icon","");const t=["duckduckgo","so360"];try{const n=t.map(t=>{const n=SUGGESTION_APIS[t];if(!n)return Promise.resolve([]);const s=Date.now(),o=s-engineLastRequestTime[t];return new Promise(i=>{if(o<200){setTimeout(()=>{engineLastRequestTime[t]=Date.now(),i(performRequest(t,n,e))},200-o)}else engineLastRequestTime[t]=s,i(performRequest(t,n,e))})}),s=await Promise.race(n);return suggestionCache.set(e,s),s}catch(e){return console.error("获取搜索建议时出错:",e),[]}}function showSuggestions(e,t){const n=document.getElementById("suggestionsContainer"),s=document.getElementById("searchQuery");if(s.value!==t)return;if(currentSuggestions=e,activeSuggestionIndex=-1,0===e.length)return void n.classList.remove("show");n.innerHTML="";e.slice(0,6).forEach((e,t)=>{const o=document.createElement("div");o.className="suggestion-item";const i=document.createTextNode(e.text||e);o.appendChild(i);const c=document.createElement("span");c.className="suggestion-source",c.textContent=e.source||"",o.appendChild(c),o.dataset.index=t,o.addEventListener("click",()=>{s.value=e.text||e,handleSearch()}),o.addEventListener("mouseenter",()=>{n.querySelectorAll(".suggestion-item").forEach(e=>{e.classList.remove("active")}),o.classList.add("active"),activeSuggestionIndex=t}),n.appendChild(o)}),n.classList.add("show")}function hideSuggestions(){document.getElementById("suggestionsContainer").classList.remove("show"),currentSuggestions=[],activeSuggestionIndex=-1}function handleSuggestionNavigation(e){const t=document.getElementById("suggestionsContainer");if(!t.classList.contains("show"))return;const n=t.querySelectorAll(".suggestion-item");switch(e.key){case"ArrowDown":e.preventDefault(),n.length>0&&(activeSuggestionIndex=(activeSuggestionIndex+1)%Math.min(currentSuggestions.length,6),updateActiveSuggestion(n));break;case"ArrowUp":e.preventDefault(),n.length>0&&(activeSuggestionIndex=(activeSuggestionIndex-1+Math.min(currentSuggestions.length,6))%Math.min(currentSuggestions.length,6),updateActiveSuggestion(n));break;case"Enter":if(e.shiftKey)return;if(e.preventDefault(),activeSuggestionIndex>=0&&activeSuggestionIndex<currentSuggestions.length){document.getElementById("searchQuery").value=currentSuggestions[activeSuggestionIndex].text||currentSuggestions[activeSuggestionIndex]}handleSearch();break;case"Escape":e.preventDefault(),hideSuggestions()}}function updateActiveSuggestion(e){e.forEach(e=>{e.classList.remove("active")}),activeSuggestionIndex>=0&&activeSuggestionIndex<e.length&&(e[activeSuggestionIndex].classList.add("active"),e[activeSuggestionIndex].scrollIntoView({block:"nearest",behavior:"smooth"}))}export{fetchSuggestions,showSuggestions,hideSuggestions,handleSuggestionNavigation};